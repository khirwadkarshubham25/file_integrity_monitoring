<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audit Logs - FIM System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            font-family: 'Poppins', sans-serif;
        }

        .navbar-custom {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .navbar-brand {
            font-weight: 700;
            font-size: 22px;
            color: white !important;
        }

        .nav-buttons {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            color: white;
        }

        .btn-logout {
            background: #ef4444;
            border: 1px solid #dc2626;
        }

        .btn-logout:hover {
            background: #dc2626;
            border-color: #b91c1c;
        }

        .container-fluid {
            padding: 40px 30px;
        }

        .page-header {
            margin-bottom: 40px;
        }

        .page-header h1 {
            font-weight: 700;
            font-size: 32px;
            color: #333;
            margin-bottom: 8px;
        }

        .page-header p {
            color: #666;
            font-size: 14px;
        }

        .filter-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            align-items: flex-end;
        }

        .form-group {
            margin-bottom: 0;
        }

        .form-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-select {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 10px 12px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.3rem rgba(102, 126, 234, 0.15);
        }

        .btn-filter {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border: none;
            color: white;
            font-weight: 600;
            padding: 10px 24px;
            border-radius: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
            width: 100%;
            cursor: pointer;
        }

        .btn-filter:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            color: white;
        }

        .card-custom {
            background: white;
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .card-header-custom {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 25px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .card-header-custom i {
            font-size: 24px;
        }

        .card-body {
            padding: 25px;
        }

        table {
            font-size: 14px;
        }

        table thead {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        table tbody tr {
            transition: all 0.3s ease;
            border-bottom: 1px solid #e5e7eb;
        }

        table tbody tr:hover {
            background: #f9fafb;
        }

        .badge-create {
            background: #dbeafe;
            color: #1e40af;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-update {
            background: #d1fae5;
            color: #065f46;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-delete {
            background: #fee2e2;
            color: #991b1b;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-login {
            background: #f3e8ff;
            color: #6b21a8;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-create {
            background: #dbeafe;
            color: #1e40af;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-update {
            background: #d1fae5;
            color: #065f46;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-delete {
            background: #fee2e2;
            color: #991b1b;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-login {
            background: #f3e8ff;
            color: #6b21a8;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark navbar-custom">
        <div class="container-fluid">
            <span class="navbar-brand">
                <i class="fas fa-shield-alt"></i> FIM System
            </span>
            <div class="nav-buttons">
                <a href="/accounts/users" class="nav-btn"><i class="fas fa-users"></i> Users</a>
                <a href="/accounts/roles" class="nav-btn"><i class="fas fa-lock"></i> Roles</a>
                <a href="/accounts/audit-logs" class="nav-btn"><i class="fas fa-history"></i> Audit Logs</a>
                <button class="nav-btn btn-logout" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="page-header">
            <h1><i class="fas fa-history"></i> Audit Logs</h1>
            <p>Track all system activities and user actions in real-time</p>
        </div>

        <div class="filter-section">
            <div class="filter-row">
                <div class="form-group">
                    <label class="form-label">Action Type</label>
                    <select class="form-select" id="actionFilter">
                        <option value="">All Actions</option>
                        <option value="create">Create</option>
                        <option value="update">Update</option>
                        <option value="delete">Delete</option>
                        <option value="login">Login</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Resource Type</label>
                    <select class="form-select" id="resourceFilter">
                        <option value="">All Resources</option>
                        <option value="Users">Users</option>
                        <option value="Role">Roles</option>
                    </select>
                </div>
                <button class="btn-filter"><i class="fas fa-sliders-h"></i> Apply Filters</button>
            </div>
        </div>

        <div class="card-custom">
            <div class="card-header-custom">
                <i class="fas fa-list"></i>
                <span>Activity Log</span>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Action</th>
                                <th>Resource</th>
                                <th>IP Address</th>
                                <th>Date & Time</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody id="auditLogsBody">
                            <!-- Logs loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Get tokens and user info from localStorage
        const apiToken = localStorage.getItem('api_token');
        const refreshToken = localStorage.getItem('refresh_token');
        const userId = localStorage.getItem('user_id');
        const roleId = localStorage.getItem('role_id');
        const adminUserId = localStorage.getItem('admin_user_id');

        // Check if user is logged in
        if (!apiToken) {
            window.location.href = '/accounts/login';
        }

        // Helper function to make API calls with token
        function makeApiCall(url, method = 'GET', data = null) {
            const options = {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiToken}`
                }
            };

            if (data) {
                options.body = JSON.stringify(data);
            }

            return fetch(url, options).then(response => response.json());
        }

        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', function() {
            // Clear localStorage
            localStorage.removeItem('api_token');
            localStorage.removeItem('refresh_token');
            localStorage.removeItem('user_id');
            localStorage.removeItem('role_id');
            localStorage.removeItem('admin_user_id');

            // Redirect to login
            window.location.href = '/accounts/login';
        });

        // Load audit logs from API using get_audit_logs_service
        function loadAuditLogs(page = 1) {
            const pageSize = 10;
            const action = document.getElementById('actionFilter').value || '';
            const resourceType = document.getElementById('resourceFilter').value || '';

            let url = `/accounts/api/audit-logs?page=${page}&page_size=${pageSize}`;
            if (action) url += `&action=${action}`;
            if (resourceType) url += `&resource_type=${resourceType}`;

            makeApiCall(url, 'GET')
                .then(response => {
                    if (response.audit_logs) {
                        const logsBody = document.getElementById('auditLogsBody');
                        logsBody.innerHTML = '';

                        response.audit_logs.forEach(log => {
                            const row = document.createElement('tr');
                            const actionBadgeClass = getActionBadgeClass(log.action);
                            const userName = `${log.user_first_name || 'System'} ${log.user_last_name || ''}`;
                            row.innerHTML = `
                                <td><strong>${userName.trim()}</strong></td>
                                <td><span class="badge-${actionBadgeClass}">${log.action.toUpperCase()}</span></td>
                                <td>${log.resource_type}</td>
                                <td>${log.ip_address || 'N/A'}</td>
                                <td>${new Date(log.created_at).toLocaleString()}</td>
                                <td>
                                    <button class="action-btn" onclick="viewLogDetails(${log.id})">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </td>
                            `;
                            logsBody.appendChild(row);
                        });
                    } else {
                        console.error('Failed to load audit logs:', response.message);
                    }
                })
                .catch(error => console.error('Error loading audit logs:', error));
        }

        // Get action badge class based on action type
        function getActionBadgeClass(action) {
            const actionMap = {
                'create': 'create',
                'update': 'update',
                'delete': 'delete',
                'login': 'login'
            };
            return actionMap[action.toLowerCase()] || 'create';
        }

        // View log details using get_audit_log_details_service
        function viewLogDetails(logId) {
            makeApiCall(`/accounts/api/audit-log-details?log_id=${logId}`, 'GET')
                .then(response => {
                    if (response.audit_log) {
                        // Remove existing modal if present
                        const existingModal = document.getElementById('logDetailsModal');
                        if (existingModal) {
                            const modal = bootstrap.Modal.getInstance(existingModal);
                            if (modal) modal.hide();
                            existingModal.remove();
                        }

                        const log = response.audit_log;
                        const userName = `${log.user_first_name || 'System'} ${log.user_last_name || ''}`;
                        const actionBadgeClass = getActionBadgeClass(log.action);

                        // Format old and new values
                        const oldValuesHtml = log.old_values ? `<pre>${JSON.stringify(log.old_values, null, 2)}</pre>` : '<p>N/A</p>';
                        const newValuesHtml = log.new_values ? `<pre>${JSON.stringify(log.new_values, null, 2)}</pre>` : '<p>N/A</p>';

                        const modalHtml = `
                            <div class="modal fade" id="logDetailsModal" tabindex="-1">
                                <div class="modal-dialog modal-lg">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">Audit Log Details</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                        </div>
                                        <div class="modal-body">
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label class="form-label"><strong>User</strong></label>
                                                    <p>${userName.trim()}</p>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label"><strong>Action</strong></label>
                                                    <p><span class="badge-${actionBadgeClass}">${log.action.toUpperCase()}</span></p>
                                                </div>
                                            </div>
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label class="form-label"><strong>Resource Type</strong></label>
                                                    <p>${log.resource_type}</p>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label"><strong>Resource ID</strong></label>
                                                    <p>${log.resource_id}</p>
                                                </div>
                                            </div>
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label class="form-label"><strong>IP Address</strong></label>
                                                    <p>${log.ip_address || 'N/A'}</p>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label"><strong>Date & Time</strong></label>
                                                    <p>${new Date(log.created_at).toLocaleString()}</p>
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label"><strong>Description</strong></label>
                                                <p>${log.description || 'N/A'}</p>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <label class="form-label"><strong>Old Values</strong></label>
                                                    <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; max-height: 200px; overflow-y: auto;">
                                                        ${oldValuesHtml}
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label"><strong>New Values</strong></label>
                                                    <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; max-height: 200px; overflow-y: auto;">
                                                        ${newValuesHtml}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;

                        document.body.insertAdjacentHTML('beforeend', modalHtml);
                        const modal = new bootstrap.Modal(document.getElementById('logDetailsModal'));
                        modal.show();
                    } else {
                        alert('Failed to load log details: ' + (response.message || 'Unknown error'));
                    }
                })
                .catch(error => console.error('Error loading log details:', error));
        }

        // Filter button
        document.querySelector('.btn-filter').addEventListener('click', function() {
            loadAuditLogs(1);  // Reset to page 1 when filtering
        });

        // Load audit logs on page load
        loadAuditLogs();
    </script>
</body>
</html>